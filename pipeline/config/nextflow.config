/*
========================================================================================
    Nextflow Configuration File for PRScs Pipeline
========================================================================================
*/

// Global default params
params {
    // Input files
    recipe = "/sc/arion/projects/va-biobank/PROJECTS/ma_PRScs_nf/pipeline/config/adlerGWAS_UKBB.recipe"   // actual configuration file
    nf_outdir = "/sc/arion/projects/va-biobank/PROJECTS/ma_PRScs_nf/results"                       // nextflow output, actual output regulated through recipe file
    scripts_dir = "/sc/arion/projects/va-biobank/PROJECTS/ma_PRScs_nf/pipeline/R"                        // targets the scripts
    
    //cluster_file = "/sc/arion/projects/va-biobank/PROJECTS/ma_PRScs_nf/pipeline/config/Clusters.csv"                             // environment specific reference parameters
    //cohort_file = "/sc/arion/projects/va-biobank/PROJECTS/ma_PRScs_nf/pipeline/config/Cohorts.csv"                               // should be constant, cohort-parameters are picked by the cohort var. (see below)
    
    // Runtime parameters
    //cluster = "minerva"         // used as reference by the Clusters.csv file
    //cohort = "psychAD_EUR"      // used as reference at the Cohorts.csv file (see above) to source cohort specific data
    //superpopulation = "EUR"     // used as reference at both Clusters.csv and Cohorts.csv
    
    // Directories
    //outdir = "/sc/arion/projects/va-biobank/PROJECTS/prscs_psychad_nf_v3/results"                       // nextflow output, actual output regulated through recipe file
    //gwas_formatted_dir = "/sc/arion/projects/va-biobank/PROJECTS/prscs_psychad_nf_v3/gwas_formatted"    // this is where the formatted gwas is stored as an intermediate file of the pipeline
    //scripts_dir = "/sc/arion/projects/va-biobank/PROJECTS/prscs_psychad_nf_v3/R"                        // targets the scripts
    //gwas_formatted_dir = "/sc/arion/projects/va-biobank/PROJECTS/ma_PRScs_nf/input_gwas/gwas_formatted"    // this is where the formatted gwas is stored as an intermediate file of the pipeline
    
    
    // Resource limits
    max_retries = 3
    max_cpus = 16
    max_memory = 128.GB
    max_time = 48.h
}

// Process configuration
process {
    
    // Global process settings
    executor = 'lsf'
    queue = 'premium'
    
    // Module loading
    beforeScript = 'source /etc/profile.d/modules.sh'
    
    // Default resources
    cpus = 1
    memory = 8.GB
    time = 1.h
    
    // Error handling
    errorStrategy = 'retry'
    maxRetries = params.max_retries
    
    // Process-specific configurations
    withName: READY_GWAS {
        cpus = 1
        memory = 16.GB
        time = 1.h
        module = 'R/4.0.3'
        clusterOptions = '-P acc_va-biobank'
    }
    
    withName: GENERATE_MODELS {
        cpus = 1
        memory = 2.GB
        time = 1.h
        module = 'R/4.0.3'
        clusterOptions = '-P acc_va-biobank'
    }
    
    withName: JOIN_MODELS {
        cpus = 1
        memory = 2.GB
        time = 1.h
        module = 'R/4.0.3'
        clusterOptions = '-P acc_va-biobank'
    }
    
    withName: SCORE_INDIVIDUALS {
        cpus = 1
        memory = 2.GB
        time = 1.h
        module = 'R/4.0.3'
        clusterOptions = '-P acc_va-biobank'
    }
}

// Executor configuration
executor {
    name = 'lsf'
    queueSize = 50
    submitRateLimit = '10 sec'
}

// Profiles for different environments
profiles {
    
    standard {
        process.executor = 'lsf'
        process.queue = 'premium'
    }
    
    test {
        process.executor = 'local'
        process.cpus = 1
        process.memory = 2.GB
    }
    
    debug {
        process.executor = 'local'
        cleanup = false
        dumpHashes = true
    }
}

// Reporting
timeline {
    enabled = true
    file = "${params.outdir}/timeline.html"
}

report {
    enabled = true
    file = "${params.outdir}/report.html"
}

trace {
    enabled = true
    file = "${params.outdir}/trace.txt"
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes'
}

dag {
    enabled = true
    file = "${params.outdir}/dag.html"
}

// Manifest
manifest {
    name = 'PRScs-Nextflow'
    author = 'Converted from Georgios Voloudakis scripts'
    homePage = 'https://github.com/your-repo/prscs-nextflow'
    description = 'Nextflow pipeline for PRScs polygenic risk score calculation'
    mainScript = 'main.nf'
    nextflowVersion = '>=21.04.0'
    version = '2.0.0'
}
